#include <math.h>
#include <stdio.h>
#include "attitude.h"

#define PI 3.14159265358979323846

#define RED "\x1b[31m"
#define GREEN "\x1b[32m"
#define RESET "\x1b[0m"

// Error tolerance
#define TOLERANCE 1e-9

// Is the deviation within threshold?
bool compare_matrices(double mat1[3][3], double mat2[3][3])
{
  for (int i = 0; i < 3; i++)
  {
    for (int j = 0; j < 3; j++)
    {
      if (fabs(mat1[i][j] - mat2[i][j]) > TOLERANCE)
      {
        return false;
      }
    }
  }

  return true;
}

bool compare_vectors(double vec1[3], double vec2[3])
{
  for (int i = 0; i < 3; i++)
  {
    if (fabs(vec1[i] - vec2[i]) > TOLERANCE)
    {
      return false;
    }
  }
  return true;
}

int main(void)
{

  euler_seq_t es[] =
  {
    EULER_XYX, EULER_XYZ, EULER_XZX, EULER_XZY,
    EULER_YXY, EULER_YXZ, EULER_YZX, EULER_YZY,
    EULER_ZXY, EULER_ZXZ, EULER_ZYX, EULER_ZYZ
  };

  double e[][3] =
  {
    {           0,           0,       0}, // Identity
    {      PI / 2,      PI / 2,  PI / 2}, // Gimbal lock
    {     -PI / 6,     -PI / 2,  PI / 4}, // Negative angle
    { 50 * PI / 7, 45 * PI / 3,  8 * PI}, // Large angles
    {-50 * PI / 7, 45 * PI / 3, -8 * PI}, // Negative and large angles

    // Random angles
    {0.433012701892219, -0.789149130992431, 0.435595740399158},
    {0.75, 0.047367172745252, -0.659739608441123},
    {0.5, 0.612372435695794, 0.612372435695794}
  };

  double turth_dcm[][12][3][3] =
  {
    {
      // {0.000000, 0.000000, 0.000000}
      {{1, 0, -0}, {0, 1, 0}, {0, -0, 1}}, // XYX
      {{1, 0, 0}, {-0, 1, 0}, {0, -0, 1}}, // XYZ
      {{1, 0, 0}, {-0, 1, 0}, {0, -0, 1}}, // XZX
      {{1, 0, 0}, {-0, 1, 0}, {0, 0, 1}}, // XZY
      {{1, 0, -0}, {0, 1, 0}, {0, -0, 1}}, // YXY
      {{1, 0, 0}, {0, 1, 0}, {0, -0, 1}}, // YXZ
      {{1, 0, -0}, {0, 1, 0}, {0, -0, 1}}, // YZX
      {{1, 0, -0}, {-0, 1, 0}, {0, 0, 1}}, // YZY
      {{1, 0, -0}, {-0, 1, 0}, {0, 0, 1}}, // ZXY
      {{1, 0, 0}, {-0, 1, 0}, {0, -0, 1}}, // ZXZ
      {{1, 0, -0}, {0, 1, 0}, {0, 0, 1}}, // ZYX
      {{1, 0, -0}, {-0, 1, 0}, {0, 0, 1}}, // ZYZ
    },

    {
      // {1.570796, 1.570796, 1.570796}
      {{6.123233996e-17, 1, -6.123233996e-17}, {1, -6.123233996e-17, 6.123233996e-17}, {6.123233996e-17, -6.123233996e-17, -1}}, // XYX
      {{3.749399457e-33, 1.224646799e-16, 1}, {-6.123233996e-17, -1, 1.224646799e-16}, {1, -6.123233996e-17, 3.749399457e-33}}, // XYZ
      {{6.123233996e-17, 6.123233996e-17, 1}, {-6.123233996e-17, -1, 6.123233996e-17}, {1, -6.123233996e-17, -6.123233996e-17}}, // XZX
      {{3.749399457e-33, 1, 0}, {-1, 3.749399457e-33, 6.123233996e-17}, {6.123233996e-17, 0, 1}}, // XZY
      {{-6.123233996e-17, 1, -6.123233996e-17}, {1, 6.123233996e-17, 6.123233996e-17}, {6.123233996e-17, -6.123233996e-17, -1}}, // YXY
      {{1, 6.123233996e-17, 0}, {0, 3.749399457e-33, 1}, {6.123233996e-17, -1, 3.749399457e-33}}, // YXZ
      {{3.749399457e-33, 1, -6.123233996e-17}, {1, 3.749399457e-33, 1.224646799e-16}, {1.224646799e-16, -6.123233996e-17, -1}}, // YZX
      {{-1, 6.123233996e-17, -6.123233996e-17}, {-6.123233996e-17, 6.123233996e-17, 1}, {6.123233996e-17, 1, -6.123233996e-17}}, // YZY
      {{-1, 1.224646799e-16, -6.123233996e-17}, {-6.123233996e-17, 3.749399457e-33, 1}, {1.224646799e-16, 1, 3.749399457e-33}}, // ZXY
      {{-6.123233996e-17, 6.123233996e-17, 1}, {-6.123233996e-17, -1, 6.123233996e-17}, {1, -6.123233996e-17, 6.123233996e-17}}, // ZXZ
      {{3.749399457e-33, 6.123233996e-17, -1}, {0, 1, 6.123233996e-17}, {1, 0, 3.749399457e-33}}, // ZYX
      {{-1, 6.123233996e-17, -6.123233996e-17}, {-6.123233996e-17, -6.123233996e-17, 1}, {6.123233996e-17, 1, 6.123233996e-17}}, // ZYZ
    },

    {
      // {-0.523599, -1.570796, 0.785398}
      {{6.123233996e-17, 0.5, 0.8660254038}, {-0.7071067812, 0.6123724357, -0.3535533906}, {-0.7071067812, -0.6123724357, 0.3535533906}}, // XYX
      {{4.329780281e-17, 0.9659258263, 0.2588190451}, {-4.329780281e-17, 0.2588190451, -0.9659258263}, {-1, 3.061616998e-17, 5.302876194e-17}}, // XYZ
      {{6.123233996e-17, -0.8660254038, 0.5}, {0.7071067812, 0.3535533906, 0.6123724357}, {-0.7071067812, 0.3535533906, 0.6123724357}}, // XZX
      {{4.329780281e-17, -0.9659258263, -0.2588190451}, {1, 5.302876194e-17, -3.061616998e-17}, {4.329780281e-17, -0.2588190451, 0.9659258263}}, // XZY
      {{0.6123724357, -0.7071067812, 0.3535533906}, {0.5, 6.123233996e-17, -0.8660254038}, {0.6123724357, 0.7071067812, 0.3535533906}}, // YXY
      {{0.9659258263, 4.329780281e-17, -0.2588190451}, {-0.2588190451, 4.329780281e-17, -0.9659258263}, {-3.061616998e-17, 1, 5.302876194e-17}}, // YXZ
      {{5.302876194e-17, -1, 3.061616998e-17}, {0.2588190451, 4.329780281e-17, 0.9659258263}, {-0.9659258263, -4.329780281e-17, 0.2588190451}}, // YZX
      {{0.3535533906, -0.7071067812, -0.6123724357}, {0.8660254038, 6.123233996e-17, 0.5}, {-0.3535533906, -0.7071067812, 0.6123724357}}, // YZY
      {{0.2588190451, -0.9659258263, -4.329780281e-17}, {3.061616998e-17, 5.302876194e-17, -1}, {0.9659258263, 0.2588190451, 4.329780281e-17}}, // ZXY
      {{0.6123724357, -0.3535533906, -0.7071067812}, {-0.6123724357, 0.3535533906, -0.7071067812}, {0.5, 0.8660254038, 6.123233996e-17}}, // ZXZ
      {{5.302876194e-17, -3.061616998e-17, 1}, {-0.2588190451, 0.9659258263, 4.329780281e-17}, {-0.9659258263, -0.2588190451, 4.329780281e-17}}, // ZYX
      {{0.3535533906, 0.6123724357, 0.7071067812}, {0.3535533906, 0.6123724357, -0.7071067812}, {-0.8660254038, 0.5, 6.123233996e-17}}, // ZYZ
    },

    {
      // {22.439948, 47.123890, 25.132741}
      {{-1, 7.444331965e-16, -1.545831461e-15}, {1.680943809e-30, -0.9009688679, -0.4338837391}, {-1.71574348e-15, -0.4338837391, 0.9009688679}}, // XYX
      {{-1, 1.627128109e-15, -1.120747995e-15}, {-9.797174393e-16, -0.9009688679, -0.4338837391}, {-1.71574348e-15, -0.4338837391, 0.9009688679}}, // XYZ
      {{-1, 1.545831461e-15, 7.444331965e-16}, {1.71574348e-15, 0.9009688679, 0.4338837391}, {1.680943809e-30, 0.4338837391, -0.9009688679}}, // XZX
      {{-1, 1.970914927e-15, -1.382617157e-16}, {1.71574348e-15, 0.9009688679, 0.4338837391}, {9.797174393e-16, 0.4338837391, -0.9009688679}}, // XZY
      {{-0.9009688679, 1.680943809e-30, 0.4338837391}, {7.444331965e-16, -1, 1.545831461e-15}, {0.4338837391, 1.71574348e-15, 0.9009688679}}, // YXY
      {{-0.9009688679, 9.797174393e-16, 0.4338837391}, {-1.382617157e-16, -1, 1.970914927e-15}, {0.4338837391, 1.71574348e-15, 0.9009688679}}, // YXZ
      {{0.9009688679, -1.71574348e-15, -0.4338837391}, {-1.120747995e-15, -1, 1.627128109e-15}, {-0.4338837391, -9.797174393e-16, -0.9009688679}}, // YZX
      {{0.9009688679, -1.71574348e-15, -0.4338837391}, {-1.545831461e-15, -1, 7.444331965e-16}, {-0.4338837391, 1.680943809e-30, -0.9009688679}}, // YZY
      {{-0.9009688679, -0.4338837391, -9.797174393e-16}, {-0.4338837391, 0.9009688679, -1.71574348e-15}, {1.627128109e-15, -1.120747995e-15, -1}}, // ZXY
      {{-0.9009688679, -0.4338837391, 1.680943809e-30}, {-0.4338837391, 0.9009688679, -1.71574348e-15}, {7.444331965e-16, -1.545831461e-15, -1}}, // ZXZ
      {{0.9009688679, 0.4338837391, 1.71574348e-15}, {0.4338837391, -0.9009688679, 9.797174393e-16}, {1.970914927e-15, -1.382617157e-16, -1}}, // ZYX
      {{0.9009688679, 0.4338837391, 1.71574348e-15}, {0.4338837391, -0.9009688679, 1.680943809e-30}, {1.545831461e-15, 7.444331965e-16, -1}}, // ZYZ
    },

    {
      // {-22.439948, 47.123890, -25.132741}
      {{-1, -7.444331965e-16, -1.545831461e-15}, {-1.680943809e-30, -0.9009688679, 0.4338837391}, {-1.71574348e-15, 0.4338837391, 0.9009688679}}, // XYX
      {{-1, -1.627128109e-15, -1.120747995e-15}, {9.797174393e-16, -0.9009688679, 0.4338837391}, {-1.71574348e-15, 0.4338837391, 0.9009688679}}, // XYZ
      {{-1, 1.545831461e-15, -7.444331965e-16}, {1.71574348e-15, 0.9009688679, -0.4338837391}, {-1.680943809e-30, -0.4338837391, -0.9009688679}}, // XZX
      {{-1, 1.970914927e-15, 1.382617157e-16}, {1.71574348e-15, 0.9009688679, -0.4338837391}, {-9.797174393e-16, -0.4338837391, -0.9009688679}}, // XZY
      {{-0.9009688679, -1.680943809e-30, -0.4338837391}, {-7.444331965e-16, -1, 1.545831461e-15}, {-0.4338837391, 1.71574348e-15, 0.9009688679}}, // YXY
      {{-0.9009688679, -9.797174393e-16, -0.4338837391}, {1.382617157e-16, -1, 1.970914927e-15}, {-0.4338837391, 1.71574348e-15, 0.9009688679}}, // YXZ
      {{0.9009688679, -1.71574348e-15, 0.4338837391}, {-1.120747995e-15, -1, -1.627128109e-15}, {0.4338837391, 9.797174393e-16, -0.9009688679}}, // YZX
      {{0.9009688679, -1.71574348e-15, 0.4338837391}, {-1.545831461e-15, -1, -7.444331965e-16}, {0.4338837391, -1.680943809e-30, -0.9009688679}}, // YZY
      {{-0.9009688679, 0.4338837391, 9.797174393e-16}, {0.4338837391, 0.9009688679, -1.71574348e-15}, {-1.627128109e-15, -1.120747995e-15, -1}}, // ZXY
      {{-0.9009688679, 0.4338837391, -1.680943809e-30}, {0.4338837391, 0.9009688679, -1.71574348e-15}, {-7.444331965e-16, -1.545831461e-15, -1}}, // ZXZ
      {{0.9009688679, -0.4338837391, 1.71574348e-15}, {-0.4338837391, -0.9009688679, -9.797174393e-16}, {1.970914927e-15, 1.382617157e-16, -1}}, // ZYX
      {{0.9009688679, -0.4338837391, 1.71574348e-15}, {-0.4338837391, -0.9009688679, -1.680943809e-30}, {1.545831461e-15, -7.444331965e-16, -1}}, // ZYZ
    },

    {
      // {0.433013, -0.789149, 0.435596}
      {{0.7044494784, -0.2978180513, 0.6442478876}, {-0.299481173, 0.6982178044, 0.6502329772}, {-0.6434764638, -0.6509963947, 0.4026682688}}, // XYX
      {{0.638667162, 0.1129995065, 0.761140833}, {-0.29724287, 0.9486075983, 0.1085831506}, {-0.7097541352, -0.2955921783, 0.6394328203}}, // XYZ
      {{0.7044494784, -0.6442478876, -0.2978180513}, {0.6434764638, 0.4026682688, 0.6509963947}, {-0.299481173, -0.6502329772, 0.6982178044}}, // XZX
      {{0.638667162, -0.4070336995, -0.6530144131}, {0.7097541352, 0.6394328203, 0.2955921783}, {0.29724287, -0.6522646977, 0.697278596}}, // XZY
      {{0.6982178044, -0.299481173, -0.6502329772}, {-0.2978180513, 0.7044494784, -0.6442478876}, {0.6509963947, 0.6434764638, 0.4026682688}}, // YXY
      {{0.697278596, 0.29724287, -0.6522646977}, {-0.6530144131, 0.638667162, -0.4070336995}, {0.2955921783, 0.7097541352, 0.6394328203}}, // YXZ
      {{0.6394328203, -0.7097541352, -0.2955921783}, {0.761140833, 0.638667162, 0.1129995065}, {0.1085831506, -0.29724287, 0.9486075983}}, // YZX
      {{0.4026682688, -0.6434764638, -0.6509963947}, {0.6442478876, 0.7044494784, -0.2978180513}, {0.6502329772, -0.299481173, 0.6982178044}}, // YZY
      {{0.9486075983, 0.1085831506, -0.29724287}, {-0.2955921783, 0.6394328203, -0.7097541352}, {0.1129995065, 0.761140833, 0.638667162}}, // ZXY
      {{0.6982178044, 0.6502329772, -0.299481173}, {-0.6509963947, 0.4026682688, -0.6434764638}, {-0.2978180513, 0.6442478876, 0.7044494784}}, // ZXZ
      {{0.6394328203, 0.2955921783, 0.7097541352}, {-0.6522646977, 0.697278596, 0.29724287}, {-0.4070336995, -0.6530144131, 0.638667162}}, // ZYX
      {{0.4026682688, 0.6509963947, 0.6434764638}, {-0.6502329772, 0.6982178044, -0.299481173}, {-0.6442478876, -0.2978180513, 0.7044494784}}, // ZYZ
    },

    {
      // {0.750000, 0.047367, -0.659740}
      {{0.9988783852, 0.03227522869, -0.03464507442}, {-0.02902101208, 0.9954607029, 0.09064088348}, {0.03741326538, -0.0895337842, 0.9952808393}}, // XYX
      {{0.7892656092, -0.4229579151, -0.4451588483}, {0.6122236737, 0.5979271638, 0.5173637793}, {0.04734946218, -0.6808742239, 0.7308681958}}, // XYZ
      {{0.9988783852, 0.03464507442, 0.03227522869}, {-0.03741326538, 0.9952808393, 0.0895337842}, {-0.02902101208, -0.09064088348, 0.9954607029}}, // XZX
      {{0.7892656092, -0.3904091087, 0.4739625788}, {-0.04734946218, 0.7308681958, 0.6808742239}, {-0.6122236737, -0.5598324823, 0.5583634705}}, // XZY
      {{0.9954607029, -0.02902101208, -0.09064088348}, {0.03227522869, 0.9988783852, 0.03464507442}, {0.0895337842, -0.03741326538, 0.9952808393}}, // YXY
      {{0.5583634705, -0.6122236737, -0.5598324823}, {0.4739625788, 0.7892656092, -0.3904091087}, {0.6808742239, -0.04734946218, 0.7308681958}}, // YXZ
      {{0.7308681958, 0.04734946218, -0.6808742239}, {-0.4451588483, 0.7892656092, -0.4229579151}, {0.5173637793, 0.6122236737, 0.5979271638}}, // YZX
      {{0.9952808393, 0.03741326538, -0.0895337842}, {-0.03464507442, 0.9988783852, 0.03227522869}, {0.09064088348, -0.02902101208, 0.9954607029}}, // YZY
      {{0.5979271638, 0.5173637793, 0.6122236737}, {-0.6808742239, 0.7308681958, 0.04734946218}, {-0.4229579151, -0.4451588483, 0.7892656092}}, // ZXY
      {{0.9954607029, 0.09064088348, -0.02902101208}, {-0.0895337842, 0.9952808393, 0.03741326538}, {0.03227522869, -0.03464507442, 0.9988783852}}, // ZXZ
      {{0.7308681958, 0.6808742239, -0.04734946218}, {-0.5598324823, 0.5583634705, -0.6122236737}, {-0.3904091087, 0.4739625788, 0.7892656092}}, // ZYX
      {{0.9952808393, 0.0895337842, -0.03741326538}, {-0.09064088348, 0.9954607029, -0.02902101208}, {0.03464507442, 0.03227522869, 0.9988783852}}, // ZYZ
    },

    {
      // {0.500000, 0.612372, 0.612372}
      {{0.8182866212, 0.2755787896, -0.5044435907}, {0.3304070055, 0.4926116328, 0.8050869456}, {0.4703596669, -0.8254635728, 0.3120443459}}, // XYX
      {{0.6695929945, 0.7299460274, -0.1372006519}, {-0.4703596669, 0.5597085129, 0.6822669305}, {0.5748104083, -0.3923075041, 0.7181140694}}, // XYZ
      {{0.8182866212, 0.5044435907, 0.2755787896}, {-0.4703596669, 0.3120443459, 0.8254635728}, {0.3304070055, -0.8050869456, 0.4926116328}}, // XZX
      {{0.6695929945, 0.6883582311, -0.2789411541}, {-0.5748104083, 0.7181140694, 0.3923075041}, {0.4703596669, -0.1023480778, 0.876519626}}, // XZY
      {{0.4926116328, 0.3304070055, -0.8050869456}, {0.2755787896, 0.8182866212, 0.5044435907}, {0.8254635728, -0.4703596669, 0.3120443459}}, // YXY
      {{0.876519626, 0.4703596669, -0.1023480778}, {-0.2789411541, 0.6695929945, 0.6883582311}, {0.3923075041, -0.5748104083, 0.7181140694}}, // YXZ
      {{0.7181140694, 0.5748104083, -0.3923075041}, {-0.1372006519, 0.6695929945, 0.7299460274}, {0.6822669305, -0.4703596669, 0.5597085129}}, // YZX
      {{0.3120443459, 0.4703596669, -0.8254635728}, {-0.5044435907, 0.8182866212, 0.2755787896}, {0.8050869456, 0.3304070055, 0.4926116328}}, // YZY
      {{0.5597085129, 0.6822669305, -0.4703596669}, {-0.3923075041, 0.7181140694, 0.5748104083}, {0.7299460274, -0.1372006519, 0.6695929945}}, // ZXY
      {{0.4926116328, 0.8050869456, 0.3304070055}, {-0.8254635728, 0.3120443459, 0.4703596669}, {0.2755787896, -0.5044435907, 0.8182866212}}, // ZXZ
      {{0.7181140694, 0.3923075041, -0.5748104083}, {-0.1023480778, 0.876519626, 0.4703596669}, {0.6883582311, -0.2789411541, 0.6695929945}}, // ZYX
      {{0.3120443459, 0.8254635728, -0.4703596669}, {-0.8050869456, 0.4926116328, 0.3304070055}, {0.5044435907, 0.2755787896, 0.8182866212}}, // ZYZ
    }
  };

  int count = 0;

  for (int i = 0; i < 8; i++)
  {
    for (int j = 0; j < 12; j ++)
    {
      double dcm[3][3], euler[3];
      euler_to_dcm(e[i], es[j], dcm);
      dcm_to_euler(dcm, euler, es[j]);

      if(compare_matrices(turth_dcm[i][j], dcm))
      {
        printf(GREEN "euler_to_dcm: %d/95 PASSED!  ", count);
      }
      else
      {
        printf(RED "euler_to_dcm: %d/95 FAILED.  ", count);
      }

      if(compare_vectors(euler, e[i]))
      {
        printf(GREEN "dcm_to_euler: %d/95 PASSED!\n", count);
      }
      else
      {
        printf(RED "dcm_to_euler: %d/95 FAILED.\n", count);
      }

      count ++;
    }
  }

  printf(RESET);

  // 0.174461059412466  + 0.595055005141286i - 0.732945697135043j + 0.279756116387487k
  // 0.219081163106642  - 0.898748787861072i - 0.297999382249188j + 0.235479146569706k
  double q1[4] = {0.174461059412466,  0.595055005141286,  0.732945697135043,  0.279756116387487};
  double q2[4] = {0.219081163106642, -0.898748787861072, 0.297999382249188, 0.235479146569706};
  double u = 0.3;

  double q[4];
  quat_slerp(q1, q2, u, q);

  // 0.0564395763769562 + 0.859378789689511i - 0.489280556589716j + 0.137430735257576k
  printf("q-slerp: %.15f, %.15f, %.15f, %.15f\n", q[0], q[1], q[2], q[3]);

  // q1 = 0.637500352868806 + 0.49338212432488i   - 0.240485730112637j + 0.54067919610524k
  // q2 = 0.697035155263178 - 0.0605889265769267i + 0.686790776520073j - 0.19695025663971k
  // qe = 2.854979893415346
  double q3[4] = {0.637500352868806,  0.49338212432488,  -0.240485730112637,  0.54067919610524};
  double q4[4] = {0.697035155263178, -0.0605889265769267, 0.686790776520073, -0.19695025663971};

  printf("q-dist: %.15f\n", quat_dist(q4, q3));
 return 0;
}
