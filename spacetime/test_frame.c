// rms (2025-02-27 00:58:43)

#include <math.h>
#include <stdio.h>
#include <string.h>
#include <stdbool.h>

#include "time.h"
#include "frame.h"
#include "attitude.h"

#define RED "\x1b[31m"
#define GREEN "\x1b[32m"
#define RESET "\x1b[0m"

// Error tolerance
#define TOLERANCE 1e-8

// Is the deviation within threshold?
bool compare_matrices(double mat1[3][3], double mat2[3][3])
{
  for (int i = 0; i < 3; i++)
  {
    for (int j = 0; j < 3; j++)
    {
      if (fabs(mat1[i][j] - mat2[i][j]) > TOLERANCE)
      {
        return false;
      }
    }
  }

  return true;
}

bool test_single_case(utc_t t, double ground_truth[3][3], const char *test_name)
{
  double dcm[3][3];
  frame_eci_to_ecef_dcm(t, dcm);

  bool status = compare_matrices(dcm, ground_truth);

  if (status)
  {
    printf(GREEN "Test %s PASSED!\n", test_name);
  }
  else
  {
    printf(RED "Test %s FAILED.\n", test_name);
  }

  return status;
}

bool test_frame_eci_to_ecef_dcm()
{
  bool status = true;

  // Test cases
  utc_t test_times[] =
  {
    {.year = 2024, .month = 1, .day = 12, .hour = 4, .minute = 52, .second = 12},
    {.year = 2023, .month = 6, .day = 15, .hour = 12, .minute = 0, .second = 0},
    {.year = 2022, .month = 12, .day = 31, .hour = 23, .minute = 59, .second = 59},
    {.year = 2021, .month = 3, .day = 20, .hour = 12, .minute = 0, .second = 0},
    {.year = 2020, .month = 7, .day = 4, .hour = 18, .minute = 30, .second = 0},
    {.year = 2019, .month = 9, .day = 23, .hour = 6, .minute = 0, .second = 0},
    {.year = 2018, .month = 2, .day = 14, .hour = 10, .minute = 15, .second = 30},
    {.year = 2017, .month = 5, .day = 1, .hour = 0, .minute = 0, .second = 0},
    {.year = 2016, .month = 8, .day = 8, .hour = 8, .minute = 8, .second = 8},
    {.year = 2015, .month = 11, .day = 11, .hour = 11, .minute = 11, .second = 11},
    {.year = 2014, .month = 4, .day = 22, .hour = 16, .minute = 45, .second = 0},
    {.year = 2013, .month = 10, .day = 31, .hour = 20, .minute = 0, .second = 0}
  };

  // Ground truth DCMs from MATLAB for each test case
  double ground_truths[][3][3] = {
    { // Test Case 1: 2024-01-12 04:52:12
      {-0.997637610071718, -0.068657153281647, 0.002322557566614},
      {0.068657043997502, -0.997640313048689, -0.000126844940965},
      {0.002325785870385, 0.000032914653284, 0.999997294814696}
    },
    { // Test Case 2: 2023-06-15 12:00:00
      {0.118135345851863, 0.992997458396542, -0.000296105502455},
      {-0.992994928395361, 0.118135713335329, 0.002241743929254},
      {0.002261026658881, 0.000029202067814, 0.999997443449576}
    },
    { // Test Case 3: 2022-12-31 23:59:59
      {-0.175236910751489, 0.984526228084138, 0.000362387491732},
      {-0.984523804613696, -0.175237283521158, 0.002184631112492},
      {0.002214330428570, 0.000026048895180, 0.999997548028098}
    },
    { // Test Case 4: 2021-03-20 12:00:00
      {0.999370507366738, -0.035418595751463, -0.002027826556472},
      {0.035418503094663, 0.999372564652670, -0.000081597043715},
      {0.002029444279118, 0.000009723097811, 0.999997940628569}
    },
    { // Test Case 5: 2020-07-04 18:30:00
      {-0.936892730101000, -0.349612136140604, 0.001834815276248},
      {0.349611453711205, -0.936894526737318, -0.000690799242776},
      {0.001960540188802, -0.000005732352496, 0.999998078122807}
    },
    { // Test Case 6: 2019-09-23 06:00:00
      {-0.027062346343195, 0.999633745658313, 0.000062861216759},
      {-0.999631972868165, -0.027062416739603, 0.001882662984409},
      {0.001883674627362, -0.000011888804394, 0.999998225812703}
    },
    { // Test Case 7: 2018-02-14 10:15:30
      {0.469961212326295, -0.882686660628696, -0.000847382416903},
      {0.882685353543536, 0.469961975056226, -0.001519421262892},
      {0.001739410394906, -0.000033902989508, 0.999998486649888}
    },
    { // Test Case 8: 2017-05-01 00:00:00
      {-0.778312296779783, -0.627876069100959, 0.001269067258962},
      {0.627875145428585, -0.778313330273630, -0.001077808612440},
      {0.001664462199486, -0.000042055906858, 0.999998613897483}
    },
    { // Test Case 9: 2016-08-08 08:08:08
      {0.189298101569868, 0.981919630977741, -0.000258925822983},
      {-0.981918352376658, 0.189298273100650, 0.001585265599304},
      {0.001605617623422, -0.000045843750941, 0.999998709944367}
    },
    { // Test Case 10: 2015-11-11 11:11:11
      {-0.789350900983387, -0.613941165684193, 0.001183298376960},
      {0.613940383190589, -0.789351786440114, -0.000981392680737},
      {0.001536556054151, -0.000048188537779, 0.999998818335980}
    },
    { // Test Case 11: 2014-04-22 16:45:00
      {-0.203297890121490, 0.979116878640318, 0.000325321059835},
      {-0.979115925705476, -0.203298146341569, 0.001366646988283},
      {0.001404244301801, -0.000040690581393, 0.999999013220622}
    },
    { // Test Case 12: 2013-10-31 20:00:00
      {0.940301701551049, -0.340339594015884, -0.001292596342967},
      {0.340339325798953, 0.940302589276643, -0.000428852370439},
      {0.001361387129830, -0.000036670754258, 0.999999072639739}
    }
  };

  // Input for each test case
  const char *test_names[] =
  {
    "2024-01-12 04:52:12",
    "2023-06-15 12:00:00",
    "2022-12-31 23:59:59",
    "2021-03-20 12:00:00",
    "2020-07-04 18:30:00",
    "2019-09-23 06:00:00",
    "2018-02-14 10:15:30",
    "2017-05-01 00:00:00",
    "2016-08-08 08:08:08",
    "2015-11-11 11:11:11",
    "2014-04-22 16:45:00",
    "2013-10-31 20:00:00"
  };

  for (size_t i = 0; i < sizeof(test_times) / sizeof(*test_times); i++)
  {
    status &= test_single_case(test_times[i], ground_truths[i], test_names[i]);
  }

  return status;
}

int main()
{
  test_frame_eci_to_ecef_dcm();
  printf(RESET);

  return 0;
}
